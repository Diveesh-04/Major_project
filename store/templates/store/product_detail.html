{% extends 'store/base.html' %}
{% block content %}
<div class="container mt-5">
    <div class="row">
        <!-- Product Image -->
        <div class="col-md-6">
            <img src="{{ product.image.url }}" class="img-fluid" alt="{{ product.name }}">
        </div>

        <!-- Product Details -->
        <div class="col-md-6">
            <h2>{{ product.name }}</h2>
            <p><strong>Category:</strong> {{ product.category.name }}</p>
            <p><strong>Price:</strong> ₹{{ product.price }}</p>
            <p><strong>Description:</strong> {{ product.description }}</p>
            <p><strong>Notes:</strong> {{ product.top_note }} | {{ product.heart_note }} | {{ product.base_note }}</p>

            <!-- Add to Cart Form -->
            <form id="add-to-cart-form">
                {% csrf_token %}
                
                <label for="quantity">Quantity:</label>
                <div class="quantity-container">
                    <button type="button" onclick="changeQuantity(-1)">-</button>
                    <input type="number" id="quantity" name="quantity" value="1" min="1">
                    <button type="button" onclick="changeQuantity(1)">+</button>
                </div>

                <button type="button" class="btn btn-success mt-3" onclick="addToCart({{ product.id }})">
                    Add to Cart
                </button>
            </form>

            <style>
                .quantity-container {
                    display: flex;
                    align-items: center;
                }
                
                .quantity-container button {
                    width: 30px;
                    height: 30px;
                    font-size: 18px;
                    border: 1px solid #ccc;
                    background-color: #f8f8f8;
                    cursor: pointer;
                }
                
                .quantity-container input {
                    width: 50px;
                    text-align: center;
                    font-size: 16px;
                    border: 1px solid #ccc;
                    margin: 0 5px;
                }
            </style>
        </div>
    </div>
</div>

<script>
    function changeQuantity(amount) {
        let quantityInput = document.getElementById("quantity");
        let currentValue = parseInt(quantityInput.value);
        let newValue = currentValue + amount;
        if (newValue >= 1) {
            quantityInput.value = newValue;
        }
    }

    function addToCart(productId) {
        let quantity = document.getElementById("quantity").value;  // ✅ Get selected quantity
        let csrfToken = document.querySelector("[name=csrfmiddlewaretoken]").value;  // ✅ Get CSRF token

        fetch(`/api/cart/add/${productId}/`, {  // ✅ Make sure this URL matches your Django view
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ quantity: quantity })  // ✅ Sending correct quantity
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to add to cart');
            }
            return response.json();
        })
        .then(data => {
            alert('Added to Cart');
            window.location.href = "{% url 'view_cart' %}";  // ✅ Redirect to cart page
        })
        .catch(error => console.error('Error:', error));
    }
</script>
{% endblock %}